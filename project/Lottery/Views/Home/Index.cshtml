@{
    ViewBag.Title = "539 投注模擬";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
    body {
        background-color: #1B1B1B;
        color: #FFFFFF;
    }

    .card {
        background-color: #2C2C2C;
        border: 1px solid #3A3A3A;
        color: #FFFFFF;
    }

    .card-header {
        background-color: #217E2A;
        color: #FFFFFF;
        font-weight: bold;
    }

    .number-btn {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin: 3px;
        font-size: 16px;
        background-color: #444444;
        color: #FFFFFF;
        border: 1px solid #666666;
        transition: all 0.2s;
    }

        .number-btn:hover {
            background-color: #2A9D4F;
            border-color: #2A9D4F;
            color: #FFFFFF;
        }

        .number-btn.selected {
            background-color: #FFCC00;
            color: #000000;
            font-weight: bold;
        }

    .number-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 8px;
        max-width: 300px;
    }

    input[type="number"] {
        background-color: #1B1B1B;
        border: 1px solid #666666;
        color: #FFFFFF;
        padding: 2px 6px;
        border-radius: 4px;
    }

    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-warning {
        border-radius: 4px;
        font-weight: bold;
    }

    .btn-outline-primary {
        color: #FFCC00;
        border-color: #FFCC00;
    }

        .btn-outline-primary:hover {
            background-color: #FFCC00;
            color: #000;
        }

    .btn-outline-secondary {
        color: #CCCCCC;
        border-color: #CCCCCC;
    }

        .btn-outline-secondary:hover {
            background-color: #CCCCCC;
            color: #000;
        }

    .btn-warning {
        background-color: #FFCC00;
        border: none;
        color: #000000;
    }

        .btn-warning:hover {
            background-color: #e6b800;
            color: #000000;
        }

    table.table {
        color: #FFFFFF;
    }

    table thead {
        background-color: #217E2A;
        color: #FFFFFF;
    }

    table tbody tr:nth-child(even) {
        background-color: #2E2E2E;
    }

    #countdown {
        font-weight: bold;
        color: #FFCC00;
    }

    #serverResult {
        white-space: pre-line;
        font-family: monospace;
        color: #FFCC00;
    }
    /* 開獎紀錄表格滾動設定 */
    #historyTable tbody {
        display: block;
        max-height: 250px;
        overflow-y: auto;
    }

        #historyTable thead,
        #historyTable tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
</style>


<div class="container mt-4">
    <h4>今彩 539 模擬投注（單機自開彩）</h4>

    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <div>請選號碼（最多 25 個號碼）</div>
                    <div>
                        <input type="number" id="randomCount" value="5" min="1" max="25" style="width:64px;" />
                        <button class="btn btn-sm btn-outline-primary" id="btnRandom">隨機選號</button>
                        <button class="btn btn-sm btn-outline-secondary" id="btnClear">清除</button>
                    </div>
                </div>
                <div class="card-body number-grid" id="numberGrid">
                    @for (int i = 1; i <= 39; i++)
                    {
                        <button type="button" class="number-btn" data-number="@i">@i.ToString("D2")</button>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">投注設定</div>
                <div class="card-body">
                    <div>已選號碼：<span id="selectedNumbers"></span></div>
                    <div>
                        <label>二星：</label>
                        <span id="count2">0</span> 組
                        每組金額：<input type="number" id="bet2" value="0" step="10" min="0" />
                    </div>
                    <div>
                        <label>三星：</label>
                        <span id="count3">0</span> 組
                        每組金額：<input type="number" id="bet3" value="0" step="10" min="0" />
                    </div>
                    <div>
                        <label>四星：</label>
                        <span id="count4">0</span> 組
                        每組金額：<input type="number" id="bet4" value="0" step="10" min="0" />
                    </div>

                    <hr />
                    <div>共選 <span id="totalCount">0</span> 球，總金額：<span id="totalAmount">0</span> 元</div>
                    <button class="btn btn-warning" id="submitBet">立即投注</button>
                    <div>距離下次開獎：<span id="countdown">05:00</span></div>
                    <div id="serverResult" class="mt-2"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">開獎紀錄</div>
                <div class="card-body">
                    <table class="table table-sm" id="historyTable">
                        <thead>
                            <tr><th>期數</th><th>開獎號碼</th><th>中獎情況</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let selectedNumbers = [];
    let countdownSec = 300; // 5分鐘倒數

    function updateUI() {
        $('#selectedNumbers').text(selectedNumbers.join(', '));
        const c = selectedNumbers.length;
        $('#count2').text(c >= 2 ? combination(c, 2) : 0);
        $('#count3').text(c >= 3 ? combination(c, 3) : 0);
        $('#count4').text(c >= 4 ? combination(c, 4) : 0);
        updateTotalAmount();
        highlightSelectedButtons();
        $('#totalCount').text(c);
    }

    function combination(n, k) { if(n<k) return 0; let num=1, denom=1; for(let i=0;i<k;i++){num*=(n-i);denom*=(i+1);} return num/denom;}

    function updateTotalAmount() {
        const bet2 = parseInt($('#bet2').val())||0;
        const bet3 = parseInt($('#bet3').val())||0;
        const bet4 = parseInt($('#bet4').val())||0;
        const count2 = parseInt($('#count2').text())||0;
        const count3 = parseInt($('#count3').text())||0;
        const count4 = parseInt($('#count4').text())||0;
        $('#totalAmount').text((count2*bet2+count3*bet3+count4*bet4));
    }

    function highlightSelectedButtons(){
        $('.number-btn').each(function(){
            let num=parseInt($(this).data('number'));
            $(this).toggleClass('selected',selectedNumbers.includes(num));
        });
    }

    $(document).on('click','.number-btn',function(){
        let num=parseInt($(this).data('number'));
        const idx=selectedNumbers.indexOf(num);
        if(idx>=0) selectedNumbers.splice(idx,1);
        else {if(selectedNumbers.length>=25){alert('最多選25號'); return;} selectedNumbers.push(num); selectedNumbers.sort((a,b)=>a-b);}
        updateUI();
    });

    $('#btnClear').click(()=>{selectedNumbers=[];updateUI();});

    $('#btnRandom').click(()=>{
        const want=parseInt($('#randomCount').val())||5;
        const available=[]; for(let i=1;i<=39;i++){if(!selectedNumbers.includes(i))available.push(i);}
        let pick=Math.min(want,25-selectedNumbers.length,available.length);
        while(pick>0){ const idx=Math.floor(Math.random()*available.length); selectedNumbers.push(available[idx]); available.splice(idx,1); pick--;}
        selectedNumbers.sort((a,b)=>a-b); updateUI();
    });

    $('#bet2,#bet3,#bet4').on('input',updateTotalAmount);

    $('#submitBet').click(()=>{
        if(selectedNumbers.length<2){alert('至少選2號');return;}
        const total=parseInt($('#totalAmount').text());
        if(total<=0){alert('請輸入投注金額');return;}
        const bet={Numbers:selectedNumbers, Bet2:parseInt($('#bet2').val()), Bet3:parseInt($('#bet3').val()), Bet4:parseInt($('#bet4').val()), TotalAmount:total};
        $.ajax({url:'/Bet/SubmitBet',type:'POST',contentType:'application/json',data:JSON.stringify(bet),success:data=>{renderResult(data);addHistory(data);}});
    });

    function renderResult(data){
        let html=`期數:${data.issueNo} 開獎號碼:${data.drawNumbers.join(', ')}\n`;
        if(data.wins.length>0){data.wins.forEach(w=>{html+=`${w.type}星:中${w.winningGroups}組 總派彩${w.totalPayout}元\n`;}); html+=`總派彩:${data.totalPayout}元`; } else{html+='未中獎';}
        $('#serverResult').text(html);
    }

    function addHistory(data){
        $('#historyTable tbody').prepend(`<tr><td>${data.issueNo}</td><td>${data.drawNumbers.join(', ')}</td><td>${data.totalPayout>0?'中獎 '+data.totalPayout+' 元':'未中獎'}</td></tr>`);
    }

    // 倒數計時，每秒更新
    setInterval(()=>{
        countdownSec--;
        let m=Math.floor(countdownSec/60), s=countdownSec%60;
        $('#countdown').text(`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`);
        if(countdownSec<=10){ $('#serverResult').append('\n投注即將截止！'); }
        if(countdownSec<=0){
            // 模擬系統自開獎
            const bet={Numbers:[]};
            $.ajax({url:'/Bet/SubmitBet',type:'POST',contentType:'application/json',data:JSON.stringify(bet),success:data=>{renderResult(data);addHistory(data);}});
            countdownSec=300; // 重置5分鐘
        }
    },1000);

    updateUI();
</script>
